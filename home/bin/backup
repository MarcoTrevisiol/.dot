#!/usr/bin/make -f
# Directories to back up
SRC_DIRS := archivio dossier scrigno snodo

BACKUP_ROOT := ~/riserva
LATEST_LINK := $(BACKUP_ROOT)/latest
LATEST_BACKUP := $(shell readlink -f $(LATEST_LINK))
DATE := $(shell date +%F)
DEST_BASE := backup-$(DATE)
DEST_DIR := $(BACKUP_ROOT)/$(DEST_BASE)

backup: $(DEST_DIR)

$(DEST_DIR): $(LATEST_BACKUP)
	mkdir -p "$@"
	rsync -av --link-dest="${LATEST_BACKUP}" --delete ${SRC_DIRS} "$@/"
	ln -sfT "${DEST_BASE}" ${LATEST_LINK}

$(LATEST_BACKUP):
	mkdir -p "$@"

.PHONY: backup
